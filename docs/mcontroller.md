# Mcontroller #

## Состав ##

Система перемещения образца предназначена для позиционирования образца в области исследования и состоит из:

* механической телескопической системы,
* шарико-винтовой передачи,
* ременно-зубчатой передачи,
* сервопривода 86SE8N,
* драйвера привода HSS86,
* концевых выключателей "HOME", "WORK" (НЗ);
* клавиш ручного управления "HOME", "WORK", "INSERT", "EJECT"
* модуля устройства mсontroller

mcontroller - асинхронное устройство управления драйвером (HSS86) сервопривода NEMO (86SE8N).      

*Основными модулями mcontroller являются:*

* DEV8IFace - модуль реализующий прием/передачу сообщений по шине асинхронных устройств (ABUS);
  
* PGEN - генератор управляющих импульсов для драйвера сервопривода с возможностью ручного управления и управления по ABUS.

## Описание команды ABUS ##

Адрес устройства - adr[7:0] = h2A

### Запись ### 

Код слова запроса req[23:0]:
		
    req[23] - бит напраления вращения двигателя (оно же направление перемещение образца):
              0 - вращение CW (к позиии HOME), 1 - вращение CCW (к позиции WORK);
              
    req[22] - бит разрешения управления двигателем по асинхронной шине (блокировка ручного управления):
              0 - ручное управление, 1 - управление по ABUS;
              
    req[21] - бит старта движения:
              0 - движение не начинать, 1 - начать движение на назаданное количество "шагов";
              
    req[17:16] - выбор скорости движения:
                 возможные значения от 0-3, соотвествуют четырем скоростям перемещения начиная с наибольшей;
              
    req[15:0] - количество шагов которое необходимо выполнить в заданном направлении;

*Некоторые особенности работы*

Регистр командного слова блокируется до окончания исполнения команды - после исполения заданного числа "шагов" регистр очищается.
Один шаг привода сечайс соотвествует 32 мкм изменения положения образца (этот коэффициент должен быть настраеваемым, и сохраняться)

В устройстве реализован плавный старт и плавный останов вращения двигателя. Это означает, что при выполнении команды движения на N шагов,
фактически будет выполнено N+M шагов, где M - количество шагов необходимых для плавного останова. M зависит от выбранной скорости движения
и N:

	если N >= 0x000F, то M = 0xF - vn
	если N < 0x000F, то M = N

где vn - величина зависящая от выбранной скорости

	vn = 0x2 при скорости = 00 (req[17:16])
 	vn = 0x4 при скорости = 01 (req[17:16])
 	vn = 0x8 при скорости = 10 (req[17:16])
 	vn = 0xF при скорости = 11 (req[17:16])

Таким образом, например, при минимальной скорости M = 0. Логично протабулировать M в зависимости от выбраной скорости M = (0xD,0xB,0x7,0x0) 
 
*Примеры запроса:*

    команда 2A E0 00 F0 - выполнить 240 шагов к позиции WORK;
    
    команда 2A 60 00 10 - выполнить 16 шагов к позиции HOME;
    
    команда 2A C0 xx xx - не запустит перемещение, заблокирует ручное управление до следующей команды.

### Чтение ### 

Декодирование ответного слова anw[23:0]:
		
    anw[23] - бит  исполенния заданной команды "DONE":
              0 - текущаяя команда исполняется, 1 - текущая команда исполнена;
              
    anw[22] - бит  ошибки "ERR":
              0 - ошибки нет, 1 - ошибка системы привода;
		
    anw[21] - бит  активации концевого выключателя "WORK":
              0 - концевой выключатель не достигнут, 1 - концевой выключатель достигнут;
    
    anw[20] - бит  активации концевого выключателя "HOME":
              0 - концевой выключатель не достигнут, 1 - концевой выключатель достигнут;
              
    anw[15:0] - выходное число счетчика текущей позиции, возвращет текущую позицию в "шагах".

Счетчик позиции сбрасывается при достижении позиции "HOME"

*Примеры ответа:*

    ответ 2A 80 00 F0 - команда выполнена, ошибок нет, концевые выключатели не достигнуты, текущая позиция 240 шагов от позиции HOME;
    
    ответ 2A 00 00 80 - команда выполняется, ошибок нет, концевые выключатели не достигнуты, текущая позиция 128 шагов от позиции HOME;
    
    ответ 2A 90 00 00 - команда выполнена, ошибок нет, достигнута позиция HOME, текущая позиция 0 шагов от позиции HOME;
