# Hardware #

## Описание работы ##

ppulser - произвольный интервальный диспетчер комманд, предназначенный для формирования импульсных последовательностей для устройств ЯМР или им подобных.
Основным требованием к импульсным последовательностям являются точность формируемых временных интервалов. Диспетчер реализован на основе FPGA Xilinx Spartan 6.
Диспетчер имеет систему управления с ПК по протоколу ethernet/MAC/IP/UDP.

## Состав ##
Основными модулями ppluser являются:

* pll_base - базовый модуль Spartan 6 генератора с фазовой автоподстройкой частоты.
  Входная частота - 50 МГц с внешнего кварца. Модуль формирует следующие частоты:
          частоту шин ABUS;
          SBUS(10 МГц);
          частоту для управляемых DDS генераторов (250 МГц);
          частоту дискретизации АЦП (10 МГц);
          частоту передачи ethernet (125 МГц).

* UDP - конечный автомат реализующий прием и декодирование сообщений ethernet/MAC/IP/UDP,
  кодирование и передачу сообщений ethernet/MAC/IP/UDP.

* pulser - модуль ядра диспетчера комманд

* ADCCMD - модуль управления и предварительной обработки данных АЦП

* RFCMD -  модуль РЧ-генераторов

* ABUS - контроллер асинхронный шины

### Асинхронная шина ABUS ###
	
Асинхронная шина - 8-ми битная паралельная двунаправленная шина, предназначенная для записи команд и чтения состояния устройств, 
которые не требуют точной приявязки к таймингу импульсной последовательности.  
	
*Структура шины ABUS:* 
	
		Abus[11]	out  	CLK	- тактовая частота шины; 
		Abus[10]	out  	CE	- разрешение такта;
		Abus[9]		inout	RE	- Read enable: 0 - запись в шину; 1 - чтение из шины;   
		Abus[8]		out  	DE	- Data enable: 0 - передача адреса устройства; 1 - передача/прием данных; 
		Abus[7:0]	inout	DT[7:0]	- адрес/данные. 
  
Команды по асинхронной шине передаются 32-битными словами. Структура командного слова ABUS 
		
		cmd[31:0] = {adr[7:0],data[23:0]}

Чтение и запись осуществляется последовательно по 1 байту за такт.
  
**Запись:** adr[7:0]req[23:0]
		
		CLK   	 	\___/'''\___/'''\___/'''\___/'''\
		CE    	 	_________________________________
		RE    	 	\________________________________
		DE     		\_______/''''''''''''''''''''''''
		DT[7:0]		 address  byte2   byte1   byte0 
	
**Чтение:** adr[7:0]anw[23:0]
	
		CLK   	 	\___/'''\___/'''\___/'''\___/'''\
		CE    	 	_________________________________
		RE    	 	/''''''''''''''''''''''''''''''''
		DE     		\_______/''''''''''''''''''''''''
		DT[7:0]		 address  byte2   byte1   byte0 

### Pulser ###
Управление синхронными устройствами, т.е. теми, которые требуют точной привязки к таймингу импульсной программы осуществляется по сихронной однонаправленной шине SBUS.
Pulser - является контроллером шины и "источником" команд передаваемых по данной шине. Для этого предварительно сформированная микропрограмма (байт-код) загружается в память Pulser
и запускается работа диспетчера.

**Управление диспетчером**
Управление и контроль состояние диспетчера Pulser происходит по асинхронной шине ABUS.  

Адрес устройства - adr[7:0] = h01
 
Код слова запроса req[23:0]:
		
		req[23:16]==h53 - запуск диспетчера(START)
		req[23:16]==h35 - останов диспетчера(STOP)
		req[23:16]==h4C - перевод диспетчера в режим загрузки новой импульсной программы (LOAD)
		req[23:16]==hFF - форсированный сброс диспетчера (RESET)
		req[23:16]==(~53*~35*~4C*~FF) - перевод в состояние ожидания (IDLE)

Декодирование ответного слова anw[23:0]:
		
		anw[23:22]	-	состояние диспетчера
		anw[21:16]	-	состояние флагов
		anw[11:0]	-	код CRC16 последней программы записанной в память

Структуры синхронной и асинхронной шины - одинаковы, таким образом создается возможность подключать одно и тоже устройство как к любой из шин в зависимости от задач устройства.
  
*Структура шины SBUS:* 
	
		Sbus[11]	out  	CLK	-	тактовая частота шины; 
		pullup		out  	CE	-	данный сигнал всегда 1, поскольку сообщения по сихронной шине всегда 4 байта;
		pulldown	out  	RE	-	данный сигнал всегда 0, поскольку сихронная шина - однонаправленная;  
		Sbus[8]		out  	DE	-	Data enable: 0 - передача адреса устройства; 1 - передача/прием данных; 
		Sbus[7:0]	inout	DT[7:0]	-	адрес/данные.
 
**Запись:**
		
		CLK      	\___/'''\___/'''\___/'''\___/'''\
		DE       	\_______/''''''''''''''''''''''''
		Data[7:0]	 address  byte2   byte1   byte0

**Команды микропрограммы диспетчера**
Микропрограмма диспетчера состоит последовательных 32-битных командных слов (структуре командного слова ABUS повторяет командное слова SBUS).
Структура командного слова импульсной программы в памяти ядра диспетчера
		
		cmd[31:0] = {adr[7:0],data[23:0]}

Команды импульсной программы интерпретируемые самим ядром диспетчера (внутренние команды управления ходом испонения программы)
 
	| команда	| адрес	|	аргумент		    |			описание								|
	|-----------|-------|-----------------------|---------------------------------------------------|
	| idle		| h00	|	xxxxxx       		| команда с адресом h00 не интерпретируется			|
	| stop		| h0F	|	xxxxxx       		| остановить испонение импульсной программы			|
	| ret		| h08	|	address[11:0]		| возврат на команду с адресом address\*			|
	| time		| h01	|	t[23:0]      		| начать интервал времени длительностью t тактов	|
	| sflg		| h02	|	flags[23:0]  		| установить регистр флагов\* => flags				|
	| cycle		| h03	|	n[15:0]      		| начало цикла из n+1 повторений					|
	| elcyc		| h04	|	xxxxxx       		| конец цикла										|
	| macro		| h06	|	address[11:0]		| переход на макрос по адресу address\*				|
	| orcam		| h07	|	xxxxxx       		| возврат из последнего макроса 					|
		
	
\* адрес первой команды = 7FF, адрес последней команды = 000
\* регистр флагов - содержит разичные биты состояния, которые могут устанавливаться синхнронно с событиями импульсной программы 
и использоваться внутренней или внешней логикой дистпетчера, например:
			
		флаг *приема данных АЦП* может быть установлен(командой F2 в импульсной программе) на время работы АЦП и считан через асинхронную шину, 
		что позволит "синхронизировать" ПО ПК с импульсной программой;
		флаг *начало времени TR* может быть установлен(командой F2 в импульсной программе) на время интервала времени отдыха TR, что может быть
		использовано для отправки следующей программы диспетчеру;

**Запись микропрограммы в память диспетчера**

Память микропрограммы диспетчера расчитана на 4096 командных слов (16 кБ). Адресация команд в памяти инверсная и начинается с адреса 7FF, 
что важно впринципе только для команд макроса которые осуществляют безусловный переход на команду с определенным номером.
Запись микропрограммы в память диспетчера Pulser осуществляется по асинхронной шине:

Адрес устройства - adr[7:0] = h02
 
Код слова запроса cmd1[31:0]cmd2[31:0]cmd3[31:0]...:

Запись осуществляется в 4 шага:
 
	1) Остановить исполнение текущей микропрограммы: h01000000
 	2) Перевести диспетчер в состояние загрузки новой микропрограммы: h014С0000
  	3) Записать новую микропрограмму: h02cmd1[31:0]cmd2[31:0]cmd3[31:0]...
	4) Запустить исполнение новой микропрограммы / первести диспетчер в режим ожидания: h01530000 / h01000000 
 
### RFCMD ###

Модуль РЧ-генераторов; имеет четыре рч-канал с независимой установкой частоты, фазы и длительности импульса
	
Команды интерпретируемые RFCMD
 
	| команда	| адрес	|	 	аргумент						|				описание									|
	|-----------|-------|---------------------------------------|-----------------------------------------------------------|
	| rfp		| hDE	|	rfch[23:22],ph[21:16],dur[15:0]		| Запуск рч-импульса длительностью dur и фазой ph на канале 
	| setfreq	| hDC	|	rfch[23:22],freq[21:0]         		| Установить частоту генератора канала rfch равной 
	
freq[21:0] = 2^22*f(МГц)/250(МГц)
	
ph[21:16] = 2^6*ph(рад)/2π

	
### ADCCMD ###
	
модуль управления и предварительной обработки данных АЦП
	
Команды интерпретируемые ADCCMD
 
	| команда	| адрес	|	 	аргумент						|				описание												|
	| adc		| hAD	|	adch[23:22],flr[21:20],ena[19:16]	| Начать (enable=AA) или завершить (enable≠AA) окно АЦП канала adch,	|
	|			|		|										| применить FIR фильтр порядка flr										|
	
## Описание протокола связи с ПК ##
 
Аппаратная система подключена к ПК посредством сетевого интерфейса Ethernet. Система связи аппаратной системы с ПК состоит из приемо-передатчика(интерфейса) физического уровня PHY на основе чипа RTL8211EE, модуля UDP, реализующего слои Eth, MAC, IP, UDP и очередей FIFO очередей входящих и исходящих сообщений. 
Интерфейс PHY подключен для работы по протоколу GMII на частоте 125 МГц, скорость передачи/приема - 1 Гбит/с. Модуль UDP имеет: 
	
	MAC адрес 	00-0A-35-01-FE-C0
	IP адрес 	192.168.0.2

Запросы ARP на данный момент не необрабатываются, поэтому у ПК не заполнена строка в таблица ARP с соотвествием MAC и IP адреса аппаратной системы. Для того чтобы ПК смог обратиться
к аппаратной части необходимо создать строчку в таблице ARP следующей командой в командной оболочке CMD от имени администратора:

	arp -s 192.168.0.2 00-0A-35-01-FE-C0 pc_ip_address 

где pc_ip_address - ip-адрес интерфейса ПК, к которому подключена аппаратная система;

Сообщения принимаются по двум портам 8080 и 8081. Длина слова всех сообщений 16-бит word[15:0], минимальная длина сообщения - 20 байт, если сообщение короче, его необходимо дополнить байтами hFF.
	
**port 8080**     	
		
Сообщения по порту 8080 транслируются через входную/выходную очереди FIFO в/из асинхронную шину ABUS в режиме полного дуплекса.
		
*Формат сообщения отправляемого с ПК:* 
		
			{word0, word1, word2, word3, hFF, hFF, ... hFF}
		
*Формат слова сообщения:*
			
			word[15:12] = h0;
			word[11]    = h0;
			word[10]    = CE;
			word[9]     = RE;
			word[8]     = DE;
			word[7:0]   = DЕ[7:0]
  
*Примеры сообщений передаваемых по UDP (пробелы и переводы строк стоят для удобства чтения):*
  	
	*Перевод диспетчера Pulser в режим ожидания (idle)*
		
  		h{0001 0100 0100 0100 FFFFFFFFFFFFFFFFFFFFFFFF}

	*Перевод диспетчера Pulser в режим исполнения микропрограммы (start)*
		
  		h{0001 0153 0100 0100 FFFFFFFFFFFFFFFFFFFFFFFF}

	*Перевод диспетчера Pulser в режим загрузки микропрограммы (load)*
		
  		h{0001 014C 0100 0100 FFFFFFFFFFFFFFFFFFFFFFFF)

 	*Чтение состояния диспетчера Pulser*
		
  		Запрос:	h{0201 FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF}
  		Ответ:	h{0201 01XX 01XX 01XX}

	*Запись микропрограммы в память диспетчера*
 
	|	действие							|	команды микропрограммы	|		|	отпр. сообщение		|
  	|---------------------------------------|-----------------------------------|-----------------------|
	|	обращение к адресу программатора	|							|		|	h{0002				|
	|	установка интервала в 8 тактов		|	time	00 00 08		|		|	01F1 0100 0100 0108	|
	|	установка частоты рч канала 1		|	setfreq 08 31 26		|		|	01DC 0108 0131 0126	|
	|	установка частоты рч канала 4		|	setfreq	C3 12 6E		|		|	01DC 01C3 0112 016E	|
	|	вкл. канала 4 в непрерыном режиме	|	rfp		C0 00 01		|   =>	|	01DE 01C0 0100 0101	|
	|	установка интервала в 2720A1 тактов	|	time	27 20 A1		|		|	01F1 0127 0120 01A1	|
	|	команда устройству С1				|	C1		55 E5 AA		|		|	01C1 0155 01E5 01AA	|
	|	рч-импусльс (rfch 1 длит. 47 тактов)|	rfp		00 00 2F		|		|	01DE 0100 0100 012F	|
	|	возврат в начало					|	ret		FF FF FF		|		|	0180 01FF 01FF 01FF}|
 
	*Чтение состояния АЦП*
 
		Запрос:	h{02AD FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF}
  		Ответ:	h{02AD 01XX 01XX 01XX}

	*Установка частоты РЧ-генератора*
 
		h{00DC 0102 0131 0126 FFFFFFFFFFFFFFFFFFFFFFFF}

**port 8081**
		
Данные АЦП транслируются через выходную очередь FIFO по широковещательному каналу с адреса 192.168.0.2:8081. Очередь FIFO имеет размер 4096 16-ти битных слов (8 кБ), отправка сообщений инициируется по двум событиям:
  	
   	1) Очередь заполнена более чем на половину (2048)
   	2) прошло 10 мс с момента начала заполнения очереди

Формат сообщения принимаемого ПК: 
		
			{word0, word1, word2, word3, word4, word5, ... wordN}
  
Сообщение не обрамляется никакими служебными байтами (кроме контейнеров Ethernet/IP/UDP) и предсталяет поток данных АЦП 
Формат слова сообщения:
			
			word[15:12] = 4-битный счетчик точек измеренных АЦП (или лучше считать окна АЦП);
			word[12] 	= Бит переполнения АЦП;
			word[11:0] 	= DT[11:0] измеренное значение АЦП в формате дополнительного кода (TWoS)

